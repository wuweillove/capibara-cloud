<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Capibara Cloud Universal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        input, select, textarea { font-size: 16px !important; }
        .xterm-viewport { overflow-y: auto !important; }
    </style>
</head>
<body class="bg-black h-[100dvh] w-screen flex flex-col md:flex-row text-white overflow-hidden">

    <div id="mobileOverlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/80 z-30 hidden md:hidden backdrop-blur-sm"></div>

    <header class="flex md:hidden items-center justify-between p-4 bg-gray-900 border-b border-gray-800 shrink-0 z-20">
        <div class="flex items-center gap-2">
            <i class="fas fa-robot text-orange-500"></i>
            <span class="font-bold">Capibara</span>
        </div>
        <button onclick="toggleMenu()" class="text-gray-300 hover:text-white p-2">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </header>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-gray-900 border-r border-gray-800 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:flex md:flex-col shadow-2xl md:shadow-none">
        
        <div class="hidden md:flex items-center gap-3 p-6 border-b border-gray-800">
            <div class="w-8 h-8 bg-orange-500 rounded flex items-center justify-center">
                <i class="fas fa-otter text-white"></i>
            </div>
            <h1 class="font-bold text-lg">Capibara<span class="text-orange-500">Cloud</span></h1>
        </div>

        <div class="flex md:hidden items-center justify-between p-6 border-b border-gray-800">
            <span class="font-bold text-lg">Configuración</span>
            <button onclick="toggleMenu()" class="text-gray-400"><i class="fas fa-times"></i></button>
        </div>

        <div class="p-6 space-y-5 flex-1 overflow-y-auto">
            
            <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                <div class="text-xs text-gray-400 uppercase font-bold mb-1">Estado</div>
                <div id="statusIndicator" class="flex items-center gap-2 text-sm font-semibold text-red-400">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span> Desconectado
                </div>
            </div>

            <div>
                <label class="block text-xs text-gray-400 mb-1">API Key</label>
                <input type="password" id="apiKey" class="w-full bg-black border border-gray-700 rounded p-2.5 text-sm focus:border-orange-500 outline-none" placeholder="sk-...">
            </div>

            <div>
                <label class="block text-xs text-gray-400 mb-1">Modelo (Escribe o Selecciona)</label>
                
                <input type="text" id="modelInput" list="modelSuggestions" 
                    class="w-full bg-black border border-gray-700 rounded p-2.5 text-sm focus:border-orange-500 outline-none text-white mb-2" 
                    placeholder="ej: gemini-2.0-flash-exp" 
                    value="gemini-1.5-pro-latest">
                
                <datalist id="modelSuggestions">
                    <option value="gemini-2.0-flash-exp">Google: Gemini 2.0 Flash (Nuevo)</option>
                    <option value="gemini-1.5-pro-latest">Google: Gemini 1.5 Pro (Siempre el último)</option>
                    <option value="gemini-1.5-flash-latest">Google: Gemini 1.5 Flash (Rápido)</option>
                    
                    <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet (Latest)</option>
                    
                    <option value="gpt-4o">OpenAI: GPT-4o</option>
                </datalist>

                <p class="text-[10px] text-gray-500 leading-tight">
                    * Tip: Si sale un modelo nuevo mañana, solo escribe su nombre arriba.
                </p>
            </div>
            
            <div class="pt-2">
                <button onclick="startAgent()" id="btnStart" class="w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold shadow-lg transition text-sm">
                    INICIAR AGENTE
                </button>
                <button onclick="stopAgent()" id="btnStop" class="w-full py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold shadow-lg transition text-sm hidden">
                    DETENER
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-black relative z-10">
        <div id="terminal-container" class="flex-1 p-2 overflow-hidden relative">
            <div id="terminal" class="absolute inset-0"></div>
        </div>

        <div class="p-3 bg-gray-900 border-t border-gray-800 flex gap-2 shrink-0 safe-area-bottom">
            <input type="text" id="cmdInput" 
                class="flex-1 bg-black border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-orange-500 outline-none transition" 
                placeholder="Escribe una orden..." 
                autocomplete="off"
                onkeydown="handleEnter(event)">
            <button onclick="sendCommand()" class="px-4 bg-orange-600 hover:bg-orange-500 rounded-lg text-white transition shadow-lg">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </main>

    <script>
        // --- UI Logic ---
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        let isMenuOpen = false;

        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // --- Terminal Logic ---
        const socket = io();
        const term = new Terminal({
            cursorBlink: true,
            theme: { background: '#000000', foreground: '#00ff00', selectionBackground: '#333' },
            fontFamily: 'Menlo, Consolas, monospace',
            fontSize: window.innerWidth < 768 ? 13 : 15,
            convertEol: true,
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));

        function fit() { try { fitAddon.fit(); } catch (e) {} }
        setTimeout(fit, 100);
        window.addEventListener('resize', fit);

        // --- Sockets ---
        socket.on('terminal_data', (data) => term.write(data));

        socket.on('status', (status) => {
            const ind = document.getElementById('statusIndicator');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const isRunning = status === 'running';

            if (isRunning) {
                ind.className = 'flex items-center gap-2 text-sm font-semibold text-green-400';
                ind.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ONLINE';
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');
                if (window.innerWidth < 768 && isMenuOpen) toggleMenu();
            } else {
                ind.className = 'flex items-center gap-2 text-sm font-semibold text-red-400';
                ind.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> OFFLINE';
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
            }
        });

        socket.on('log', (data) => {
            term.write(`\r\n\x1b[33m[SYSTEM]: ${data.msg}\x1b[0m\r\n`);
        });

        // --- Commands ---
        function startAgent() {
            const apiKey = document.getElementById('apiKey').value;
            // AHORA LEEMOS DEL INPUT DE TEXTO, NO DE UN SELECT FIJO
            const model = document.getElementById('modelInput').value;
            
            if (!apiKey) return alert("Por favor ingresa tu API Key.");
            if (!model) return alert("Por favor escribe o selecciona un modelo.");
            
            term.clear();
            term.write(`Iniciando entorno cloud con modelo: ${model}...\r\n`);
            socket.emit('start_agent', { apiKey, model });
        }

        function stopAgent() {
            socket.emit('stop_agent');
        }

        function sendCommand() {
            const input = document.getElementById('cmdInput');
            const cmd = input.value;
            if (cmd) {
                term.write(`\r\n\x1b[1;34m> ${cmd}\x1b[0m\r\n`);
                socket.emit('send_command', cmd);
                input.value = '';
                if (window.innerWidth > 768) input.focus();
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendCommand();
        }
    </script>
</body>
</html>