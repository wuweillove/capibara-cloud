<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capibara Cloud - Agente Autónomo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 h-screen flex flex-col text-white overflow-hidden">

    <nav class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-6">
        <div class="flex items-center gap-3">
            <i class="fas fa-robot text-orange-500 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-wide">Capibara<span class="text-orange-500">Cloud</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <span id="statusIndicator" class="flex items-center gap-2 text-xs text-gray-400 uppercase font-bold">
                <span class="w-2 h-2 rounded-full bg-red-500"></span> Desconectado
            </span>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-gray-900 border-r border-gray-700 p-6 flex flex-col gap-6 overflow-y-auto">
            
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                <h3 class="text-sm font-semibold text-gray-300 mb-3"><i class="fas fa-key mr-2"></i>Configuración</h3>
                
                <label class="block text-xs text-gray-500 mb-1">API Key (Anthropic/OpenAI)</label>
                <input type="password" id="apiKey" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white mb-4 focus:border-orange-500 outline-none" placeholder="sk-...">
                
                <label class="block text-xs text-gray-500 mb-1">Modelo</label>
                <select id="model" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white outline-none">
                    <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                    <option value="gpt-4o">GPT-4o</option>
                </select>
            </div>

            <div class="space-y-3">
                <button onclick="startAgent()" id="btnStart" class="w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition shadow-lg shadow-green-900/50">
                    <i class="fas fa-play mr-2"></i> INICIAR AGENTE
                </button>
                <button onclick="stopAgent()" id="btnStop" class="w-full py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold transition shadow-lg shadow-red-900/50 hidden">
                    <i class="fas fa-square mr-2"></i> DETENER
                </button>
            </div>

            <div class="mt-auto text-xs text-gray-600 text-center">
                El código se ejecuta en un contenedor seguro en la nube.
            </div>
        </aside>

        <main class="flex-1 bg-black p-2 relative flex flex-col">
            <div id="terminal" class="flex-1 w-full h-full"></div>
            
            <div class="h-16 bg-gray-800 border-t border-gray-700 p-3 flex gap-2">
                <input type="text" id="cmdInput" class="flex-1 bg-gray-900 border border-gray-600 rounded px-4 text-white focus:outline-none focus:border-orange-500" placeholder="Escribe tu instrucción aquí..." onkeydown="handleEnter(event)">
                <button onclick="sendCommand()" class="px-6 bg-orange-600 hover:bg-orange-500 rounded text-white font-bold transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </main>
    </div>

    <script>
        const socket = io();
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#000000',
                foreground: '#00ff00',
            },
            fontFamily: 'Menlo, monospace',
            fontSize: 14
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        window.addEventListener('resize', () => fitAddon.fit());

        // Recepción de datos del backend
        socket.on('terminal_data', (data) => {
            term.write(data);
        });

        socket.on('status', (status) => {
            const ind = document.getElementById('statusIndicator');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');

            if (status === 'running') {
                ind.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ONLINE';
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');
            } else {
                ind.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> OFFLINE';
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
            }
        });

        socket.on('log', (data) => {
            term.write(`\r\n\x1b[33m[SISTEMA]: ${data.msg}\x1b[0m\r\n`);
        });

        function startAgent() {
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;
            
            if (!apiKey) {
                alert("Necesitas una API Key para encender el cerebro del agente.");
                return;
            }

            term.clear();
            term.write('Inicializando entorno cloud...\r\n');
            socket.emit('start_agent', { apiKey, model });
        }

        function stopAgent() {
            socket.emit('stop_agent');
        }

        function sendCommand() {
            const input = document.getElementById('cmdInput');
            const cmd = input.value;
            if (cmd) {
                socket.emit('send_command', cmd);
                input.value = '';
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendCommand();
        }
    </script>
</body>
</html>